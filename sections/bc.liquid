{% comment %}
Section: Box Customizer for Shopify
Fixed Liquid comparison error by guarding against blank handles.
Copy this file into /sections/box-customizer.liquid.
{% endcomment %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<div class="box-customizer">
  <!-- ICON NAV -->
  <div class="customizer-icons">
    <div class="icon-step active" data-step="1">
      <img src="{{ 'icon-packaging.svg' | asset_url }}" alt="Pick your giftbox">
      <p>PICK YOUR GIFTBOX</p>
    </div>
    <div class="icon-step" data-step="2">
      <img src="{{ 'icon-gifts.svg' | asset_url }}" alt="Choose your gifts">
      <p>CHOOSE YOUR GIFTS</p>
    </div>
    <div class="icon-step" data-step="3">
      <img src="{{ 'icon-card.svg' | asset_url }}" alt="Pick a card">
      <p>PICK A CARD</p>
    </div>
    <div class="icon-step" data-step="4">
      <img src="{{ 'icon-enjoy.svg' | asset_url }}" alt="Enjoy gifting">
      <p>ENJOY GIFTING</p>
    </div>
  </div>

  <!-- PROGRESS BAR -->
  <div class="customizer-progress">
    <div class="progress-line-bg"></div>
    <div class="progress-line-fill"></div>
    {% for i in (1..4) %}
      <div class="progress-step{% if i == 1 %} active{% endif %}" data-step="{{ i }}">
        <span class="step-label">
          {% case i %}
            {% when 1 %}STEP 1<br>Packaging
            {% when 2 %}STEP 2<br>Gifts
            {% when 3 %}STEP 3<br>Card
            {% when 4 %}DONE<br>Done!
          {% endcase %}
        </span>
      </div>
    {% endfor %}
  </div>

  <!-- STEP CONTENT -->
  <div class="customizer-content">
    {% assign packHandle  = section.settings.packaging_collection  | default: '' %}
    {% assign giftsHandle = section.settings.gifts_collection      | default: '' %}
    {% assign cardHandle  = section.settings.cards_collection       | default: '' %}

    <!-- STEP 1 -->
    <div class="step-content active" id="step-1">
      <p class="small-label">STEP 1 OF 3</p>
      <h2>CHOOSE YOUR BOX COLOR</h2>
      <p class="description">Welcome to the easiest way to send someone a custom gift in 3 simple steps.</p>
      <div class="box-options">
        {% if packHandle != '' and collections[packHandle].products_count > 0 %}
          {% for product in collections[packHandle].products %}
            <div class="option-item" data-product-id="{{ product.id }}">
              <img src="{{ product.featured_image | img_url: '150x150' }}" alt="{{ product.title }}">
              <p>{{ product.title }}</p>
            </div>
          {% endfor %}
        {% else %}
          <p class="empty-message">Please select a Packaging Collection in section settings.</p>
        {% endif %}
      </div>
      <button class="btn btn--primary" data-action="next-step">Choose Your Gifts</button>
    </div>

    <!-- STEP 2 -->
    <div class="step-content" id="step-2">
      <p class="small-label">STEP 2 OF 3</p>
      <h2>CHOOSE YOUR GIFTS</h2>
      <p class="description">Select from these hand-picked gifts!</p>
      <div class="gift-options">
        {% if giftsHandle != '' and collections[giftsHandle].products_count > 0 %}
          {% for product in collections[giftsHandle].products %}
            <div class="option-item" data-product-id="{{ product.id }}">
              <img src="{{ product.featured_image | img_url: '120x120' }}" alt="{{ product.title }}">
              <p>{{ product.title }}</p>
              <p class="price">{{ product.price | money }}</p>
            </div>
          {% endfor %}
        {% else %}
          <p class="empty-message">Please select a Gifts Collection in section settings.</p>
        {% endif %}
      </div>
      <aside class="box-summary">
        <h3>Box Content</h3>
        <ul id="summary-list"></ul>
        <p class="subtotal">Subtotal: <span id="box-subtotal">{{ section.settings.base_box_price | money }}</span></p>
        <button class="btn btn--primary" data-action="next-step">Choose Your Card</button>
      </aside>
    </div>

    <!-- STEP 3 -->
    <div class="step-content" id="step-3">
      <p class="small-label">STEP 3 OF 3</p>
      <h2>CHOOSE YOUR CARD</h2>
      <p class="description">Pick the perfect card design.</p>
      <div class="card-options">
        {% if cardHandle != '' and collections[cardHandle].products_count > 0 %}
          {% for product in collections[cardHandle].products %}
            <div class="option-item" data-product-id="{{ product.id }}">
              <img src="{{ product.featured_image | img_url: '120x120' }}" alt="{{ product.title }}">
              <p>{{ product.title }}</p>
            </div>
          {% endfor %}
        {% else %}
          <p class="empty-message">Please select a Cards Collection in section settings.</p>
        {% endif %}
      </div>
      <button class="btn btn--primary" data-action="next-step">Build My Box</button>
    </div>

    <!-- STEP 4 -->
    <div class="step-content" id="step-4">
      <p class="small-label">DONE!</p>
      <h2>BUILDING YOUR BOX</h2>
      <p>Please wait while we prepare your custom gift box!</p>
      <div class="checkmark-circle">
        <svg viewBox="0 0 52 52" class="checkmark"><path d="M14 27l7 7 16-16"/></svg>
      </div>
      <button class="btn btn--primary" onclick="location.href='{{ routes.cart_url }}';">PROCEED TO CHECKOUT</button>
      <button class="btn btn--secondary" onclick="location.reload();">BUILD ANOTHER BOX</button>
    </div>
  </div>
</div>

<style>
/* ————————————————
   (keep your existing CSS here)
   ———————————————— */
</style>

<script>
(function(){
  var current = 1, total = 4;
  var fill = document.querySelector('.progress-line-fill');
  var steps = document.querySelectorAll('.progress-step');

  function updateProgress(step){
    var pct = (step-1)/(total-1)*100;
    fill.style.width = pct + '%';
    steps.forEach(function(el){
      var s = parseInt(el.dataset.step,10);
      el.classList.toggle('active', s===step);
      el.style.left = (5 + (s-1)*(90/(total-1))) + '%';
    });
  }

  function showStep(step){
    current = step; updateProgress(step);
    document.querySelectorAll('.icon-step').forEach(function(el){
      el.classList.toggle('active', parseInt(el.dataset.step,10)===step);
    });
    document.querySelectorAll('.step-content').forEach(function(el){
      el.classList.toggle('active', el.id==='step-'+step);
    });
  }

  document.querySelectorAll('[data-action="next-step"]').forEach(function(btn){
    btn.addEventListener('click', function(){
      if(current < total) showStep(current+1);
    });
  });

  document.querySelectorAll('.option-item').forEach(function(item){
    item.addEventListener('click', function(){
      var pane = this.closest('.step-content');
      pane.querySelectorAll('.option-item').forEach(function(i){ i.classList.remove('selected'); });
      this.classList.add('selected');
      if(pane.id==='step-2'){
        var title = this.querySelector('p').innerText;
        var price = this.querySelector('.price').innerText;
        document.getElementById('summary-list').innerHTML = '<li>'+title+' – '+price+'</li>';
        document.getElementById('box-subtotal').innerText = price;
      }
    });
  });

  updateProgress(1);
})();
</script>

{% schema %}
{
  "name": "Box Customizer",
  "settings": [
    { "type":"collection","id":"packaging_collection","label":"Packaging Collection" },
    { "type":"collection","id":"gifts_collection","label":"Gifts Collection" },
    { "type":"collection","id":"cards_collection","label":"Cards Collection" },
    { "type":"number","id":"base_box_price","label":"Base Box Price","default":21000 }
  ],
  "presets": [
    { "name":"Box Customizer" }
  ]
}
{% endschema %}
