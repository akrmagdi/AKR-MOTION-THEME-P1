{% comment %}
  Custom Gift Box Builder â€“ Shopify Liquid 2.0 Section
  File: sections/custom-gift-box.liquid
  Creates a 3-step gift box builder: choose items, choose addons, review & checkout.
{% endcomment %}

<section class="custom-box-builder" data-id="custom-box-builder">
  <div class="builder-container" id="gift-box-app">

    <!-- STEP 1: Choose Products -->
    <div class="step step-1" data-id="step-1">
      <h2>{{ section.settings.main_heading }}</h2>
      <div class="product-grid" id="product-options">
        {% for product in collections[section.settings.main_collection].products %}
          <div class="product-card" data-id="product-{{ product.id }}" data-handle="{{ product.handle }}">
            <img src="{{ product.featured_image | image_url: width: 300 }}" alt="{{ product.title }}">
            <h3>{{ product.title }}</h3>
            <button type="button" class="add-product" data-product-id="{{ product.id }}">Add to Box</button>
          </div>
        {% endfor %}
      </div>
      <button type="button" class="next-step" data-id="to-step-2">Next: Choose Add-ons</button>
    </div>

    <!-- STEP 2: Add-ons (Optional) -->
    <div class="step step-2 hidden" data-id="step-2">
      <h2>Step 2: Optional Add-ons</h2>
      <div class="product-grid" id="addon-options">
        {% for product in collections[section.settings.addon_collection].products %}
          <div class="product-card" data-id="addon-{{ product.id }}" data-handle="{{ product.handle }}">
            <img src="{{ product.featured_image | image_url: width: 300 }}" alt="{{ product.title }}">
            <h3>{{ product.title }}</h3>
            <button type="button" class="add-product" data-product-id="{{ product.id }}">Add to Box</button>
          </div>
        {% endfor %}
      </div>
      <button type="button" class="prev-step" data-id="back-to-step-1">Back</button>
      <button type="button" class="next-step" data-id="to-step-3">Next: Review Your Box</button>
    </div>

    <!-- STEP 3: Review -->
    <div class="step step-3 hidden" data-id="step-3">
      <h2>Step 3: Review Your Gift Box</h2>
      <ul id="selected-items-list"></ul>
      <button type="button" class="prev-step" data-id="back-to-step-2">Back</button>
      <button type="button" id="checkout-btn">Go to Checkout</button>
    </div>

  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    var selectedItems = [];
    var steps = document.querySelectorAll(".step");

    function showStep(index) {
      steps.forEach(function(step, i) {
        step.classList.toggle("hidden", i !== index);
      });
    }

    function renderReview() {
      var list = document.getElementById("selected-items-list");
      list.innerHTML = "";
      selectedItems.forEach(function(id) {
        var el = document.createElement("li");
        el.innerText = "Product ID: " + id;
        list.appendChild(el);
      });
    }

    document.querySelectorAll(".add-product").forEach(function(button) {
      button.addEventListener("click", function() {
        var productId = this.getAttribute("data-product-id");
        if (!selectedItems.includes(productId)) {
          selectedItems.push(productId);
        }
      });
    });

    document.querySelector("[data-id='to-step-2']").addEventListener("click", function() {
      showStep(1);
    });
    document.querySelector("[data-id='back-to-step-1']").addEventListener("click", function() {
      showStep(0);
    });
    document.querySelector("[data-id='to-step-3']").addEventListener("click", function() {
      showStep(2);
      renderReview();
    });
    document.querySelector("[data-id='back-to-step-2']").addEventListener("click", function() {
      showStep(1);
    });

    document.getElementById("checkout-btn").addEventListener("click", function() {
      var form = document.createElement("form");
      form.method = "POST";
      form.action = "/cart";

      selectedItems.forEach(function(id) {
        var input = document.createElement("input");
        input.type = "hidden";
        input.name = "items[][id]";
        input.value = id;
        form.appendChild(input);
      });

      document.body.appendChild(form);
      form.submit();
    });

    // Initialize with step 1
    showStep(0);
  });
</script>

<style>
  .hidden { display: none; }
  .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem; }
  .product-card { border: 1px solid #ddd; padding: 10px; text-align: center; }
  button { margin: 10px 5px; padding: 10px 15px; }
</style>

{% schema %}
{
  "name": "Custom Gift Box Builder",
  "tag": "section",
  "class": "section-custom-gift-box",
  "settings": [
    {
      "type": "header",
      "content": "Customize Your Box Settings"
    },
    {
      "type": "text",
      "id": "main_heading",
      "label": "Main Heading",
      "default": "Customize Your Gift Box"
    },
    {
      "type": "collection",
      "id": "main_collection",
      "label": "Main Gift Collection"
    },
    {
      "type": "collection",
      "id": "addon_collection",
      "label": "Add-On Collection"
    }
  ],
  "presets": [
    {
      "name": "Gift Box Builder",
      "category": "Custom Sections"
    }
  ]
}
{% endschema %}
