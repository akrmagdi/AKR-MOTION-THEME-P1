{% comment %}
  Custom Gift Flow â€“ Shopify Liquid 2.0 Section
  File: sections/custom-gift-box-flow.liquid
  4-step builder: Packaging -> Gifts -> Card -> Review -> Checkout
  Enhanced UI/UX: animated transitions, progress bar, sticky summary with thumbnails
{% endcomment %}

<section class="gift-flow" data-id="gift-flow">
  <!-- Progress Bar -->
  <div class="progress-bar" id="progress-bar">
    <div class="progress-step active" data-step="1"></div>
    <div class="progress-step" data-step="2"></div>
    <div class="progress-step" data-step="3"></div>
    <div class="progress-step" data-step="4"></div>
  </div>

  <!-- Sticky Summary Bar -->
  <div class="box-summary" id="box-summary">
    <h4>Your Box (<span id="summary-count">0</span>)</h4>
    <div class="summary-thumbnails" id="summary-items">
      <span class="empty-msg">No items added yet</span>
    </div>
  </div>

  <!-- Steps Container -->
  <div class="flow-steps">
    <!-- Step 1: Packaging -->
    <div class="step" data-step="1">
      <h2>{{ section.settings.packaging_heading }}</h2>
      <p>{{ section.settings.packaging_subheading }}</p>
      <div class="grid">
        {% assign col = collections[section.settings.packaging_collection] %}
        {% for product in col.products %}
          <div class="card" data-id="product-{{ product.id }}" data-price="{{ product.price | money_without_currency }}">
            {% if product.featured_image %}
              <img class="card-img" src="{{ product.featured_image | img_url: '300x' }}" alt="{{ product.title }}">
            {% endif %}
            <div class="card-info">
              <h3>{{ product.title }}</h3>
              <span class="price">{{ product.price | money }}</span>
              <button type="button" class="btn select-item">Add</button>
            </div>
          </div>
        {% endfor %}
      </div>
      <button class="btn next-step">{{ section.settings.next_button_label }}</button>
    </div>

    <!-- Step 2: Gifts -->
    <div class="step hidden" data-step="2">
      <h2>{{ section.settings.gifts_heading }}</h2>
      <p>{{ section.settings.gifts_subheading }}</p>
      <div class="grid">
        {% assign col = collections[section.settings.gifts_collection] %}
        {% for product in col.products %}
          <div class="card" data-id="product-{{ product.id }}" data-price="{{ product.price | money_without_currency }}">
            {% if product.featured_image %}
              <img class="card-img" src="{{ product.featured_image | img_url: '300x' }}" alt="{{ product.title }}">
            {% endif %}
            <div class="card-info">
              <h3>{{ product.title }}</h3>
              <span class="price">{{ product.price | money }}</span>
              <button type="button" class="btn select-item">Add</button>
            </div>
          </div>
        {% endfor %}
      </div>
      <div class="flow-nav">
        <button class="btn back-step">{{ section.settings.back_button_label }}</button>
        <button class="btn next-step">{{ section.settings.next_button_label }}</button>
      </div>
    </div>

    <!-- Step 3: Card -->
    <div class="step hidden" data-step="3">
      <h2>{{ section.settings.card_heading }}</h2>
      <p>{{ section.settings.card_subheading }}</p>
      <div class="grid">
        {% assign col = collections[section.settings.card_collection] %}
        {% for product in col.products %}
          <div class="card" data-id="product-{{ product.id }}" data-price="{{ product.price | money_without_currency }}">
            {% if product.featured_image %}
              <img class="card-img" src="{{ product.featured_image | img_url: '300x' }}" alt="{{ product.title }}">
            {% endif %}
            <div class="card-info">
              <h3>{{ product.title }}</h3>
              <span class="price">{{ product.price | money }}</span>
              <button type="button" class="btn select-item">Add</button>
            </div>
          </div>
        {% endfor %}
      </div>
      <div class="flow-nav">
        <button class="btn back-step">{{ section.settings.back_button_label }}</button>
        <button class="btn next-step">Review</button>
      </div>
    </div>

    <!-- Step 4: Review -->
    <div class="step hidden" data-step="4">
      <h2>Review Your Box</h2>
      <div id="review-list" class="review-list"></div>
      <div class="total">Total: <span id="review-total">$0.00</span></div>
      <button class="btn back-step">{{ section.settings.back_button_label }}</button>
      <button class="btn checkout-step">{{ section.settings.checkout_button_label }}</button>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var selected = [];
    var steps = document.querySelectorAll('.step');
    var progress = document.querySelectorAll('.progress-step');
    var summaryCount = document.getElementById('summary-count');
    var summaryItems = document.getElementById('summary-items');
    var reviewList = document.getElementById('review-list');
    var reviewTotal = document.getElementById('review-total');

    function updateSummary() {
      summaryCount.textContent = selected.length;
      summaryItems.innerHTML = selected.length ? selected.map(function(i){ return '<img src="'+i.img+'" alt="'+i.title+'">'; }).join('') : '<span class="empty-msg">No items added yet</span>';
    }

    function goToStep(n) {
      steps.forEach(function(s){ s.classList.toggle('hidden', parseInt(s.getAttribute('data-step')) !== n); s.classList.add('fade'); setTimeout(()=>s.classList.remove('fade'),300); });
      progress.forEach(function(p,i){ p.classList.toggle('active', i+1 <= n); });
      if(n===4) renderReview();
    }

    function renderReview() {
      var total=0;
      reviewList.innerHTML = selected.map(function(item){ total+=parseFloat(item.price); return '<div class="review-item"><img src="'+item.img+'"><span>'+item.title+'</span><span>$'+(+item.price).toFixed(2)+'</span></div>'; }).join('');
      reviewTotal.textContent = '$'+total.toFixed(2);
    }

    document.body.addEventListener('click', function(e){
      if(e.target.matches('.select-item')){
        var card = e.target.closest('.card');
        var id = card.getAttribute('data-id');
        var price = card.getAttribute('data-price');
        var img = card.querySelector('img').src;
        var title = card.querySelector('h3').innerText;
        selected.push({id:id,price:price,title:title,img:img});
        updateSummary();
      }
      if(e.target.matches('.next-step')){
        var cur = parseInt(document.querySelector('.progress-step.active + .progress-step.active')? document.querySelectorAll('.progress-step.active').length : document.querySelectorAll('.progress-step.active').length);
        goToStep(cur+1);
      }
      if(e.target.matches('.back-step')){
        var cur = document.querySelectorAll('.progress-step.active').length;
        goToStep(cur-1);
      }
      if(e.target.matches('.checkout-step')){
        var form = document.createElement('form'); form.method='POST'; form.action='/cart/add';
        selected.forEach(function(item){ var inp = document.createElement('input'); inp.type='hidden'; inp.name='items[][id]'; inp.value=item.id.replace('product-',''); form.appendChild(inp); });
        document.body.appendChild(form); form.submit();
      }
    });

    goToStep(1);
  });
</script>

<style>
  .progress-bar { display:flex; margin-bottom:1rem; }
  .progress-step { flex:1; height:4px; background:#eee; margin-right:4px; transition:background .3s; }
  .progress-step.active { background:#333; }
  .box-summary { position:sticky; top:0; background:#fff; padding:1rem; border-bottom:1px solid #ddd; display:flex; align-items:center; }
  .box-summary h4 { margin:0 1rem 0 0; }
  .summary-thumbnails img { width:40px; height:40px; object-fit:cover; border-radius:4px; margin-right:4px; transition:transform .3s; }
  .summary-thumbnails img:hover { transform:scale(1.1); }
  .flow-indicators, .flow-steps { max-width:1200px; margin:0 auto; }
  .indicator { flex:1; padding:.5rem; text-align:center; cursor:default; }
  .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:1rem; }
  .card { border:1px solid #f0f0f0; padding:1rem; text-align:center; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.05); transition:transform .3s,box-shadow .3s; }
  .card:hover { transform:translateY(-4px); box-shadow:0 4px 12px rgba(0,0,0,0.1); }
  .card-img { max-width:100%; height:auto; border-radius:4px; }
  .card-info { margin-top:.5rem; }
  .btn { background:#333; color:#fff; padding:.5rem 1rem; border:none; border-radius:4px; cursor:pointer; transition:background .3s; }
  .btn:hover { background:#555; }
  .flow-nav { display:flex; justify-content:space-between; margin-top:1rem; }
  .review-list { margin:1rem 0; }
  .review-item { display:flex; align-items:center; margin-bottom:.5rem; }
  .review-item img { width:50px; height:50px; object-fit:cover; border-radius:4px; margin-right:.5rem; }
  .total { font-weight:bold; margin:1rem 0; }
  .fade { animation:fadeIn .3s ease; }
  @keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
</style>

{% schema %}
{  "name": "Custom Gift Flow",  "settings": [
    {"type":"collection","id":"packaging_collection","label":"Packaging Collection"},
    {"type":"text","id":"packaging_heading","label":"Packaging Heading","default":"Choose Your Box Color"},
    {"type":"text","id":"packaging_subheading","label":"Packaging Subheading","default":"Pick your favorite box style."},
    {"type":"collection","id":"gifts_collection","label":"Gifts Collection"},
    {"type":"text","id":"gifts_heading","label":"Gifts Heading","default":"Choose Your Gifts"},
    {"type":"text","id":"gifts_subheading","label":"Gifts Subheading","default":"Select items to fill your box."},
    {"type":"collection","id":"card_collection","label":"Card Collection"},
    {"type":"text","id":"card_heading","label":"Card Heading","default":"Select a Card"},
    {"type":"text","id":"card_subheading","label":"Card Subheading","default":"Add a personal message."},
    {"type":"text","id":"next_button_label","label":"Next Button Label","default":"Next"},
    {"type":"text","id":"back_button_label","label":"Back Button Label","default":"Back"},
    {"type":"text","id":"checkout_button_label","label":"Checkout Button Label","default":"Checkout"}
  ],  "presets":[{"name":"Custom Gift Flow","category":"Custom Sections"}]
}
{% endschema %}
