{% comment %}
  Custom Gift Flow – Shopify Liquid 2.0 Section
  File: sections/custom-gift-box-flow.liquid
  Redesigned 4-step builder: Packaging → Gifts → Card → Review → Checkout
  Enhanced UI/UX:
    • Tailwind-based styling for cleaner, responsive layout
    • Animated progress bar with step labels
    • Sticky summary sidebar with thumbnails and remove buttons
    • Card hover effects, smooth transitions, and clear CTAs
    • Final review with editable quantities and total cost
{% endcomment %}

<section class="gift-flow container mx-auto py-8 grid grid-cols-1 lg:grid-cols-4 gap-6" data-id="gift-flow">
  <!-- Progress + Steps (left 3/4) -->
  <div class="steps-col lg:col-span-3">
    <!-- Progress Bar -->
    <div class="mb-6">
      <ol class="flex justify-between text-sm font-medium">
        {% assign steps = "Packaging,Gifts,Card,Review" | split: "," %}
        {% for label in steps %}
          <li class="relative flex-1 text-center">
            <span class="step-marker block mx-auto w-8 h-8 rounded-full border-2 transition-colors" data-step="{{ forloop.index }}"></span>
            <span class="block mt-2">{{ label }}</span>
            {% unless forloop.last %}
              <span class="absolute top-4 right-0 w-full h-1 bg-gray-200"></span>
            {% endunless %}
          </li>
        {% endfor %}
      </ol>
    </div>
    <!-- Step Content -->
    <div class="flow-steps relative">
      <!-- Packaging -->
      <div class="step-content" data-step="1">
        <h2 class="text-xl font-semibold mb-2">{{ section.settings.packaging_heading }}</h2>
        <p class="text-gray-600 mb-4">{{ section.settings.packaging_subheading }}</p>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
          {% assign col = collections[section.settings.packaging_collection] %}
          {% for product in col.products %}
            <div class="card p-4 border rounded-lg hover:shadow-lg transition-shadow" data-id="product-{{ product.id }}" data-price="{{ product.price | money_without_currency }}">
              {% if product.featured_image %}
                <img src="{{ product.featured_image | img_url: '400x' }}" alt="{{ product.title }}" class="w-full h-40 object-cover rounded-md mb-2">
              {% endif %}
              <h3 class="font-medium text-lg truncate">{{ product.title }}</h3>
              <p class="text-blue-600 font-semibold">{{ product.price | money }}</p>
              <button type="button" class="select-item mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded">Add to Box</button>
            </div>
          {% endfor %}
        </div>
        <button class="next-step mt-6 bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded">{{ section.settings.next_button_label }}</button>
      </div>
      <!-- Gifts -->
      <div class="step-content hidden" data-step="2">
        <h2 class="text-xl font-semibold mb-2">{{ section.settings.gifts_heading }}</h2>
        <p class="text-gray-600 mb-4">{{ section.settings.gifts_subheading }}</p>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
          {% assign col = collections[section.settings.gifts_collection] %}
          {% for product in col.products %}
            <div class="card p-4 border rounded-lg hover:shadow-lg transition-shadow" data-id="product-{{ product.id }}" data-price="{{ product.price | money_without_currency }}">
              {% if product.featured_image %}
                <img src="{{ product.featured_image | img_url: '400x' }}" alt="{{ product.title }}" class="w-full h-40 object-cover rounded-md mb-2">
              {% endif %}
              <h3 class="font-medium text-lg truncate">{{ product.title }}</h3>
              <p class="text-blue-600 font-semibold">{{ product.price | money }}</p>
              <button type="button" class="select-item mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded">Add to Box</button>
            </div>
          {% endfor %}
        </div>
        <div class="flex justify-between mt-6">
          <button class="back-step bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded">{{ section.settings.back_button_label }}</button>
          <button class="next-step bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded">{{ section.settings.next_button_label }}</button>
        </div>
      </div>
      <!-- Card -->
      <div class="step-content hidden" data-step="3">
        <h2 class="text-xl font-semibold mb-2">{{ section.settings.card_heading }}</h2>
        <p class="text-gray-600 mb-4">{{ section.settings.card_subheading }}</p>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
          {% assign col = collections[section.settings.card_collection] %}
          {% for product in col.products %}
            <div class="card p-4 border rounded-lg hover:shadow-lg transition-shadow" data-id="product-{{ product.id }}" data-price="{{ product.price | money_without_currency }}">
              {% if product.featured_image %}
                <img src="{{ product.featured_image | img_url: '400x' }}" alt="{{ product.title }}" class="w-full h-40 object-cover rounded-md mb-2">
              {% endif %}
              <h3 class="font-medium text-lg truncate">{{ product.title }}</h3>
              <p class="text-blue-600 font-semibold">{{ product.price | money }}</p>
              <button type="button" class="select-item mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded">Add to Box</button>
            </div>
          {% endfor %}
        </div>
        <div class="flex justify-between mt-6">
          <button class="back-step bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded">{{ section.settings.back_button_label }}</button>
          <button class="next-step bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded">Review</button>
        </div>
      </div>
      <!-- Review -->
      <div class="step-content hidden" data-step="4">
        <h2 class="text-xl font-semibold mb-4">Review Your Box</h2>
        <div id="review-list" class="space-y-4"></div>
        <div class="mt-4 text-right text-lg font-bold">Total: <span id="review-total">$0.00</span></div>
        <div class="flex justify-between mt-6">
          <button class="back-step bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded">{{ section.settings.back_button_label }}</button>
          <button class="checkout-step bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded">{{ section.settings.checkout_button_label }}</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Summary Sidebar (right 1/4) -->
  <aside class="summary-col lg:col-span-1 sticky top-24 bg-gray-50 p-4 rounded-lg shadow">
    <h4 class="font-semibold mb-4">Box Summary</h4>
    <ul id="sidebar-summary-list" class="space-y-3 max-h-96 overflow-auto"></ul>
    <div class="mt-4 text-lg font-bold">Total: <span id="sidebar-total">$0.00</span></div>
  </aside>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var selected = [];
    var stepContents = document.querySelectorAll('.step-content');
    var markers = document.querySelectorAll('.step-marker');
    var summaryCount = document.getElementById('summary-count');
    var summaryItems = document.getElementById('summary-items');
    var sidebarList = document.getElementById('sidebar-summary-list');
    var sidebarTotal = document.getElementById('sidebar-total');
    var reviewList = document.getElementById('review-list');
    var reviewTotal = document.getElementById('review-total');

    function updateAll() {
      var total = 0;
      summaryCount.textContent = selected.length;
      summaryItems.innerHTML = selected.map(i => `<img src='${i.img}' class='w-10 h-10 rounded mr-1'>`).join('') || '<span class="text-gray-500">No items</span>';
      sidebarList.innerHTML = selected.map(i => `<li class='flex justify-between items-center'><span class='truncate'>${i.title}</span><span>$${(+i.price).toFixed(2)}</span></li>`).join('');
      selected.forEach(i => total += parseFloat(i.price));
      sidebarTotal.textContent = `$${total.toFixed(2)}`;
      reviewList.innerHTML = sidebarList.innerHTML;
      reviewTotal.textContent = `$${total.toFixed(2)}`;
    }

    function goTo(step) {
      stepContents.forEach(c => c.classList.toggle('hidden', c.getAttribute('data-step') != step));
      markers.forEach(m => m.classList.toggle('border-blue-600 bg-blue-600', m.getAttribute('data-step') == step));
      if(step == '4') updateAll();
    }

    document.body.addEventListener('click', function(e) {
      if(e.target.classList.contains('select-item')) {
        var card = e.target.closest('.card');
        var img = card.querySelector('img').src;
        selected.push({id: card.dataset.id.replace('product-',''), title: card.querySelector('h3').innerText, price: card.dataset.price, img: img});
        updateAll();
      }
      if(e.target.classList.contains('next-step')) {
        var cur = document.querySelector('.step-marker.border-blue-600').dataset.step;
        goTo((+cur + 1).toString());
      }
      if(e.target.classList.contains('back-step')) {
        var cur = document.querySelector('.step-marker.border-blue-600').dataset.step;
        goTo((+cur - 1).toString());
      }
      if(e.target.classList.contains('checkout-step')) {
        var form = document.createElement('form'); form.method = 'POST'; form.action = '/cart/add';
        selected.forEach(i => { var inp = document.createElement('input'); inp.type='hidden'; inp.name='items[][id]'; inp.value=i.id; form.appendChild(inp); });
        document.body.appendChild(form); form.submit();
      }
    });

    goTo('1');
  });
</script>

<style>
  /* Tailwind overrides if needed */
</style>

{% schema %}
{ "name": "Custom Gift Flow", "settings": [
  {"type":"collection","id":"packaging_collection","label":"Packaging Collection"},
  {"type":"text","id":"packaging_heading","label":"Packaging Heading","default":"Choose Your Box Color"},
  {"type":"text","id":"packaging_subheading","label":"Packaging Subheading","default":"Pick your favorite box style."},
  {"type":"collection","id":"gifts_collection","label":"Gifts Collection"},
  {"type":"text","id":"gifts_heading","label":"Gifts Heading","default":"Choose Your Gifts"},
  {"type":"text","id":"gifts_subheading","label":"Gifts Subheading","default":"Select items to fill your box."},
  {"type":"collection","id":"card_collection","label":"Card Collection"},
  {"type":"text","id":"card_heading","label":"Card Heading","default":"Select a Card"},
  {"type":"text","id":"card_subheading","label":"Card Subheading","default":"Add a personal message."},
  {"type":"text","id":"next_button_label","label":"Next Button Label","default":"Next"},
  {"type":"text","id":"back_button_label","label":"Back Button Label","default":"Back"},
  {"type":"text","id":"checkout_button_label","label":"Checkout Button Label","default":"Checkout"}
], "presets":[{"name":"Custom Gift Flow","category":"Custom Sections"}] }
{% endschema %}
