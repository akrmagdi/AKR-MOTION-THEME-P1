{% comment %}
  Custom Gift Flow â€“ Shopify Liquid 2.0 Section
  File: sections/custom-gift-box-flow.liquid
  Updated: Removed all cart drawer overrides and direct cart interactions.
{% endcomment %}

<!-- Load Tailwind Browser & DaisyUI + Font Awesome -->
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link href="https://cdn.jsdelivr.net/npm/daisyui@3/dist/full.css" rel="stylesheet">

<section class="gift-flow container mx-auto py-12 grid grid-cols-1 lg:grid-cols-4 gap-8" data-id="gift-flow">
  <!-- Main Steps Column -->
  <div class="lg:col-span-3 space-y-12">
    <!-- Top Icon Steps -->
    <div class="grid grid-cols-4 gap-6 text-center">
      <div><i class="fas fa-box-open text-4xl text-primary mb-2"></i><p class="font-semibold">Pick Your Giftbox</p></div>
      <div><i class="fas fa-gift text-4xl text-primary mb-2"></i><p class="font-semibold">Choose Your Gifts</p></div>
      <div><i class="fas fa-credit-card text-4xl text-primary mb-2"></i><p class="font-semibold">Pick A Card</p></div>
      <div><i class="fas fa-heart text-4xl text-primary mb-2"></i><p class="font-semibold">Enjoy Gifting</p></div>
    </div>
    <!-- DaisyUI Horizontal Steps -->
    <ul class="steps steps-horizontal mb-8">
      <li class="step step-primary">Packaging</li>
      <li class="step">Gifts</li>
      <li class="step">Card</li>
      <li class="step">Done!</li>
    </ul>
    <!-- Step Contents -->
    {% for idx in (1..4) %}
      <div class="step-content {% unless forloop.first %}hidden{% endunless %}" data-step="{{ idx }}">
        {% case idx %}
        {% when 1 %}
          <h2 class="text-2xl font-bold mb-4">{{ section.settings.packaging_heading }}</h2>
          <p class="text-gray-600 mb-6">{{ section.settings.packaging_subheading }}</p>
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for p in collections[section.settings.packaging_collection].products %}
              <div class="card bg-base-100 shadow-lg group p-4" data-id="{{ p.id }}" data-price="{{ p.price | money_without_currency }}">
                <figure><img src="{{ p.featured_image | img_url: '400x' }}" alt="{{ p.title }}" class="object-cover h-48 w-full rounded-md"/></figure>
                <div class="p-2">
                  <h3 class="font-medium truncate">{{ p.title }}</h3>
                  <p class="text-primary font-semibold">{{ p.price | money }}</p>
                  <button class="select-item btn btn-primary w-full mt-2"><i class="fas fa-plus mr-2"></i>Add to Box</button>
                </div>
              </div>
            {% endfor %}
          </div>
        {% when 2 %}
          <h2 class="text-2xl font-bold mb-4">{{ section.settings.gifts_heading }}</h2>
          <p class="text-gray-600 mb-6">{{ section.settings.gifts_subheading }}</p>
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for p in collections[section.settings.gifts_collection].products %}
              <div class="card bg-base-100 shadow-lg group p-4" data-id="{{ p.id }}" data-price="{{ p.price | money_without_currency }}">
                <figure><img src="{{ p.featured_image | img_url: '400x' }}" alt="{{ p.title }}" class="object-cover h-48 w-full rounded-md"/></figure>
                <div class="p-2">
                  <h3 class="font-medium truncate">{{ p.title }}</h3>
                  <p class="text-primary font-semibold">{{ p.price | money }}</p>
                  <button class="select-item btn btn-primary w-full mt-2"><i class="fas fa-plus mr-2"></i>Add to Box</button>
                </div>
              </div>
            {% endfor %}
          </div>
        {% when 3 %}
          <h2 class="text-2xl font-bold mb-4">{{ section.settings.card_heading }}</h2>
          <p class="text-gray-600 mb-6">{{ section.settings.card_subheading }}</p>
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for p in collections[section.settings.card_collection].products %}
              <div class="card bg-base-100 shadow-lg group p-4" data-id="{{ p.id }}" data-price="{{ p.price | money_without_currency }}">
                <figure><img src="{{ p.featured_image | img_url: '400x' }}" alt="{{ p.title }}" class="object-cover h-48 w-full rounded-md"/></figure>
                <div class="p-2">
                  <h3 class="font-medium truncate">{{ p.title }}</h3>
                  <button class="select-item btn btn-secondary w-full mt-2"><i class="fas fa-check mr-2"></i>Select Card</button>
                </div>
              </div>
            {% endfor %}
          </div>
        {% when 4 %}
          <h2 class="text-2xl font-bold mb-4">Review Your Box</h2>
          <div id="review-list" class="space-y-4 mb-4"></div>
          <div class="text-right text-xl font-bold mb-6">Total: <span id="review-total">$0.00</span></div>
          <button class="checkout-step btn btn-success w-full"><i class="fas fa-shopping-cart mr-2"></i>Proceed to Checkout</button>
        {% endcase %}
        {% unless forloop.last %}
          <div class="flex justify-end mt-8">
            <button class="next-step btn btn-accent"><i class="fas fa-arrow-right mr-2"></i>{{ section.settings.next_button_label }}</button>
          </div>
        {% endunless %}
      </div>
    {% endfor %}
  </div>
  <!-- Summary Sidebar -->
  <aside class="summary-col lg:col-span-1 sticky top-32 bg-base-100 p-6 rounded-xl shadow-xl">
    <h4 class="text-lg font-semibold mb-4">Box Summary</h4>
    <ul id="sidebar-summary-list" class="space-y-3 max-h-80 overflow-auto"></ul>
    <div class="mt-6 text-lg font-bold">Total: <span id="sidebar-total">$0.00</span></div>
  </aside>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    let selected = [];
    const contents = document.querySelectorAll('.step-content');
    const markers = document.querySelectorAll('.step-marker');
    const sidebar = document.getElementById('sidebar-summary-list');
    const stotal = document.getElementById('sidebar-total');
    const rlist = document.getElementById('review-list');
    const rtotal = document.getElementById('review-total');

    function updateAll() {
      let sum = 0;
      sidebar.innerHTML = selected.map(i => `<li class="flex justify-between"><span>${i.title}</span><span>$${(+i.price).toFixed(2)}</span></li>`).join('');
      selected.forEach(i => sum += +i.price);
      stotal.textContent = '$' + sum.toFixed(2);
      if (rlist) rlist.innerHTML = sidebar.innerHTML;
      if (rtotal) rtotal.textContent = '$' + sum.toFixed(2);
    }

    function goTo(step) {
      contents.forEach(c => c.classList.toggle('hidden', c.dataset.step !== step));
      markers.forEach(m => m.classList.toggle('border-blue-600 bg-blue-600', m.dataset.step === step));
      updateAll();
    }

    document.body.addEventListener('click', e => {
      if (e.target.closest('.select-item')) {
        const card = e.target.closest('.card');
        selected.push({ id: card.dataset.id, price: card.dataset.price, title: card.querySelector('h3').innerText });
        updateAll();
      }
      if (e.target.closest('.next-step')) {
        const cur = document.querySelector('.step-marker.bg-blue-600').dataset.step;
        goTo((+cur + 1).toString());
      }
      if (e.target.closest('.back-step')) {
        const cur = document.querySelector('.step-marker.bg-blue-600').dataset.step;
        goTo((+cur - 1).toString());
      }
      if (e.target.closest('.checkout-step')) {
        window.location.href = '/checkout';
      }
    });

    goTo('1');
  });
</script>

{% schema %}
{
  "name": "Custom Gift Flow",
  "settings": [
    { "type": "collection", "id": "packaging_collection", "label": "Packaging Collection" },
    { "type": "text", "id": "packaging_heading", "label": "Packaging Heading", "default": "Choose Your Box Color" },
    { "type": "text", "id": "packaging_subheading", "label": "Packaging Subheading", "default": "Pick your favorite box style." },
    { "type": "collection", "id": "gifts_collection", "label": "Gifts Collection" },
    { "type": "text", "id": "gifts_heading", "label": "Gifts Heading", "default": "Choose Your Gifts" },
    { "type": "text", "id": "gifts_subheading", "label": "Gifts Subheading", "default": "Select items to fill your box." },
    { "type": "collection", "id": "card_collection", "label": "Card Collection" },
    { "type": "text", "id": "card_heading", "label": "Card Heading", "default": "Select a Card" },
    { "type": "text", "id": "card_subheading", "label": "Card Subheading", "default": "Add a personal message." },
    { "type": "text", "id": "next_button_label", "label": "Next Button Label", "default": "Next" },
    { "type": "text", "id": "back_button_label", "label": "Back Button Label", "default": "Back" },
    { "type": "text", "id": "checkout_button_label", "label": "Checkout Button Label", "default": "Proceed to Checkout" }
  ],
  "presets": [
    { "name": "Custom Gift Flow", "category": "Custom Sections" }
  ]
}
{% endschema %}
