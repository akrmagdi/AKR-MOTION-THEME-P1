{% comment %}
  Custom Gift Box Flow – Shopify Liquid 2.0 Section
  File: sections/custom-gift-box-flow.liquid
  3-step builder: Packaging -> Gifts -> Card -> Checkout
{% endcomment %}

<section class="gift-flow" data-id="gift-flow">
  <!-- Step Indicators -->
  <div class="flow-indicators" data-id="flow-indicators">
    <div class="indicator active" data-step="1">Packaging</div>
    <div class="indicator" data-step="2">Gifts</div>
    <div class="indicator" data-step="3">Card</div>
  </div>

  <!-- Steps Container -->
  <div class="flow-steps" data-id="flow-steps">
    <!-- STEP 1: Packaging -->
    <div class="step step-1" data-id="step-1">
      <h2>{{ section.settings.packaging_heading }}</h2>
      <p>{{ section.settings.packaging_subheading }}</p>
      <div class="grid packaging-grid" data-id="packaging-grid">
        {% for product in collections[section.settings.packaging_collection].products %}
        <div class="card packaging-card" data-id="packaging-{{ product.id }}">
          <img src="{{ product.featured_image | img_url: '300x' }}" alt="{{ product.title }}">
          <h3>{{ product.title }}</h3>
          <span class="price">{{ product.price | money }}</span>
          <button type="button" class="btn select-packaging" data-id="select-packaging-{{ product.id }}" data-product-id="{{ product.id }}">{{ section.settings.select_button_label }}</button>
        </div>
        {% endfor %}
      </div>
      <button type="button" class="btn next-step" data-id="to-step-2">{{ section.settings.next_button_label }}</button>
    </div>

    <!-- STEP 2: Gifts -->
    <div class="step step-2 hidden" data-id="step-2">
      <h2>{{ section.settings.gifts_heading }}</h2>
      <p>{{ section.settings.gifts_subheading }}</p>
      <div class="grid gifts-grid" data-id="gifts-grid">
        {% for product in collections[section.settings.gifts_collection].products %}
        <div class="card gift-card" data-id="gift-{{ product.id }}">
          <img src="{{ product.featured_image | img_url: '300x' }}" alt="{{ product.title }}">
          <h3>{{ product.title }}</h3>
          <span class="price">{{ product.price | money }}</span>
          <button type="button" class="btn add-gift" data-id="add-gift-{{ product.id }}" data-product-id="{{ product.id }}">{{ section.settings.add_button_label }}</button>
        </div>
        {% endfor %}
      </div>
      <div class="flow-nav">
        <button type="button" class="btn back-step" data-id="back-to-step-1">{{ section.settings.back_button_label }}</button>
        <button type="button" class="btn next-step" data-id="to-step-3">{{ section.settings.next_button_label }}</button>
      </div>
    </div>

    <!-- STEP 3: Card -->
    <div class="step step-3 hidden" data-id="step-3">
      <h2>{{ section.settings.card_heading }}</h2>
      <p>{{ section.settings.card_subheading }}</p>
      <div class="grid card-grid" data-id="card-grid">
        {% for product in collections[section.settings.card_collection].products %}
        <div class="card card-card" data-id="card-{{ product.id }}">
          <img src="{{ product.featured_image | img_url: '300x' }}" alt="{{ product.title }}">
          <h3>{{ product.title }}</h3>
          <button type="button" class="btn select-card" data-id="select-card-{{ product.id }}" data-product-id="{{ product.id }}">{{ section.settings.select_button_label }}</button>
        </div>
        {% endfor %}
      </div>
      <div class="flow-nav">
        <button type="button" class="btn back-step" data-id="back-to-step-2">{{ section.settings.back_button_label }}</button>
        <button type="button" class="btn checkout-step" data-id="flow-checkout">{{ section.settings.checkout_button_label }}</button>
      </div>
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var currentStep = 1;
  var selectedPackaging = null;
  var selectedGifts = [];
  var selectedCard = null;

  function showStep(step) {
    document.querySelectorAll('[data-id^="step-"]').forEach(function(el) {
      el.classList.toggle('hidden', el.getAttribute('data-id') !== 'step-' + step);
    });
    document.querySelectorAll('[data-id="flow-indicators"] .indicator').forEach(function(ind) {
      ind.classList.toggle('active', parseInt(ind.getAttribute('data-step')) === step);
    });
  }

  document.querySelectorAll('.select-packaging').forEach(function(btn) {
    btn.addEventListener('click', function() {
      selectedPackaging = this.getAttribute('data-product-id');
    });
  });

  document.querySelectorAll('.add-gift').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var id = this.getAttribute('data-product-id');
      if (!selectedGifts.includes(id)) selectedGifts.push(id);
    });
  });

  document.querySelectorAll('.select-card').forEach(function(btn) {
    btn.addEventListener('click', function() {
      selectedCard = this.getAttribute('data-product-id');
    });
  });

  document.querySelector('[data-id="to-step-2"]').addEventListener('click', function() { showStep(2); });
  document.querySelector('[data-id="back-to-step-1"]').addEventListener('click', function() { showStep(1); });
  document.querySelector('[data-id="to-step-3"]').addEventListener('click', function() { showStep(3); });
  document.querySelector('[data-id="back-to-step-2"]').addEventListener('click', function() { showStep(2); });

  document.querySelector('[data-id="flow-checkout"]').addEventListener('click', function() {
    var form = document.createElement('form');
    form.method = 'POST';
    form.action = '/cart/add';
    if (selectedPackaging) {
      var input = document.createElement('input'); input.type = 'hidden'; input.name = 'items[][id]'; input.value = selectedPackaging; form.appendChild(input);
    }
    selectedGifts.forEach(function(id) { var input = document.createElement('input'); input.type = 'hidden'; input.name = 'items[][id]'; input.value = id; form.appendChild(input); });
    if (selectedCard) { var input = document.createElement('input'); input.type = 'hidden'; input.name = 'items[][id]'; input.value = selectedCard; form.appendChild(input); }
    document.body.appendChild(form);
    form.submit();
  });

  showStep(1);
});
</script>

<style>
  .hidden { display: none; }
  .gift-flow { padding: 2rem; }
  .flow-indicators { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
  .indicator { flex: 1; text-align: center; padding: 0.75rem; border-bottom: 2px solid #ddd; cursor: default; }
  .indicator.active { border-color: #333; font-weight: bold; }
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
  .card { border: 1px solid #eee; padding: 1rem; text-align: center; }
  .btn { background: #333; color: #fff; padding: 0.5rem 1rem; border: none; cursor: pointer; }
</style>

{% schema %}
{
  "name": "Custom Gift Flow",
  "settings": [
    { "type":"text","id":"packaging_heading","label":"Packaging Heading","default":"Choose Your Box Color" },
    { "type":"text","id":"packaging_subheading","label":"Packaging Subheading","default":"Welcome to the easiest way to send someone a custom gift, in 3 simple steps." },
    { "type":"collection","id":"packaging_collection","label":"Packaging Collection" },
    { "type":"text","id":"gifts_heading","label":"Gifts Heading","default":"Choose Your Gifts" },
    { "type":"text","id":"gifts_subheading","label":"Gifts Subheading","default":"We’ve hand-selected the best gifts in one place. Select from the items below and fill up your gift box!" },
    { "type":"collection","id":"gifts_collection","label":"Gifts Collection" },
    { "type":"text","id":"card_heading","label":"Card Heading","default":"Pick A Card" },
    { "type":"text","id":"card_subheading","label":"Card Subheading","default":"Complete your box with a hand-written card." },
    { "type":"collection","id":"card_collection","label":"Card Collection" },
    { "type":"text","id":"select_button_label","label":"Select Button Label","default":"Select" },
    { "type":"text","id":"add_button_label","label":"Add To Box Label","default":"Add To Box" },
    { "type":"text","id":"next_button_label","label":"Next Button Label","default":"Next" },
    { "type":"text","id":"back_button_label","label":"Back Button Label","default":"Back" },
    { "type":"text","id":"checkout_button_label","label":"Checkout Button Label","default":"Go to Checkout" }
  ],
  "presets":[{"name":"Custom Gift Flow","category":"Custom Sections"}]
}
{% endschema %}
