{% comment %}
  Custom Gift Flow â€“ Shopify Liquid 2.0 Section (Variants for Packaging)
  File: sections/custom-gift-box-flow.liquid
  Updated: Packaging step uses product variants rather than a collection
{% endcomment %}

<section class="gift-flow" data-id="gift-flow">
  <!-- Debug Info (remove in production) -->
  <div class="debug-info">
    <p>Packaging Product Handle: "{{ section.settings.packaging_product_handle }}" ({{ all_products[section.settings.packaging_product_handle].variants.size }} variants)</p>
    <p>Gifts Collection: "{{ section.settings.gifts_collection }}" ({{ collections[section.settings.gifts_collection].products_count }} products)</p>
    <p>Card Collection: "{{ section.settings.card_collection }}" ({{ collections[section.settings.card_collection].products_count }} products)</p>
  </div>

  <!-- Step Indicators -->
  <div class="flow-indicators" data-id="flow-indicators">
    <div class="indicator active" data-step="1">{{ section.settings.packaging_step_label }}</div>
    <div class="indicator" data-step="2">{{ section.settings.gifts_step_label }}</div>
    <div class="indicator" data-step="3">{{ section.settings.card_step_label }}</div>
  </div>

  <!-- Steps Container -->
  <div class="flow-steps" data-id="flow-steps">
    <!-- STEP 1: Packaging (Variants) -->
    <div class="step step-1" data-id="step-1">
      <h2>{{ section.settings.packaging_heading }}</h2>
      <p>{{ section.settings.packaging_subheading }}</p>
      <div class="grid packaging-grid" data-id="packaging-grid">
        {% assign pack_product = all_products[section.settings.packaging_product_handle] %}
        {% if pack_product and pack_product.variants.size > 0 %}
          {% for variant in pack_product.variants %}
            <div class="card packaging-card" data-id="packaging-variant-{{ variant.id }}">
              {% if variant.featured_image %}
                <img src="{{ variant.featured_image | img_url: '300x' }}" alt="{{ variant.title }}">
              {% endif %}
              <h3>{{ variant.title }}</h3>
              <span class="price">{{ variant.price | money }}</span>
              <button type="button" class="btn select-packaging" data-variant-id="{{ variant.id }}">{{ section.settings.select_button_label }}</button>
            </div>
          {% endfor %}
        {% else %}
          <p>No packaging variants found. Please set a valid product handle in theme settings.</p>
        {% endif %}
      </div>
      <button type="button" class="btn next-step" data-id="to-step-2">{{ section.settings.next_button_label }}</button>
    </div>

    <!-- STEP 2: Gifts -->
    <div class="step step-2 hidden" data-id="step-2">
      <h2>{{ section.settings.gifts_heading }}</h2>
      <p>{{ section.settings.gifts_subheading }}</p>
      <div class="grid gifts-grid" data-id="gifts-grid">
        {% assign gifts_col = collections[section.settings.gifts_collection] %}
        {% if gifts_col and gifts_col.products_count > 0 %}
          {% for product in gifts_col.products %}
            {% render 'product-card', product: product %}
          {% endfor %}
        {% else %}
          <p>No gift items found. Please select a different collection in theme settings.</p>
        {% endif %}
      </div>
      <div class="flow-nav">
        <button type="button" class="btn back-step" data-id="back-to-step-1">{{ section.settings.back_button_label }}</button>
        <button type="button" class="btn next-step" data-id="to-step-3">{{ section.settings.next_button_label }}</button>
      </div>
    </div>

    <!-- STEP 3: Card -->
    <div class="step step-3 hidden" data-id="step-3">
      <h2>{{ section.settings.card_heading }}</h2>
      <p>{{ section.settings.card_subheading }}</p>
      <div class="grid card-grid" data-id="card-grid">
        {% assign card_col = collections[section.settings.card_collection] %}
        {% if card_col and card_col.products_count > 0 %}
          {% for product in card_col.products %}
            {% render 'product-card', product: product %}
          {% endfor %}
        {% else %}
          <p>No cards found. Please select a different collection in theme settings.</p>
        {% endif %}
      </div>
      <div class="flow-nav">
        <button type="button" class="btn back-step" data-id="back-to-step-2">{{ section.settings.back_button_label }}</button>
        <button type="button" class="btn checkout-step" data-id="flow-checkout">{{ section.settings.checkout_button_label }}</button>
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var selectedPackaging = null;
    var selectedGifts = [];
    var selectedCard = null;

    function showStep(step) {
      document.querySelectorAll('[data-id^="step-"]').forEach(function(el) {
        el.classList.toggle('hidden', el.getAttribute('data-id') !== 'step-' + step);
      });
      document.querySelectorAll('.flow-indicators .indicator').forEach(function(ind) {
        ind.classList.toggle('active', parseInt(ind.getAttribute('data-step')) === step);
      });
    }

    document.body.addEventListener('click', function(event) {
      var btn = event.target;
      if (btn.matches('.select-packaging')) {
        selectedPackaging = btn.dataset.variantId;
      } else if (btn.matches('.add-gift')) {
        var id = btn.dataset.productId;
        if (!selectedGifts.includes(id)) selectedGifts.push(id);
      } else if (btn.matches('.select-card')) {
        selectedCard = btn.dataset.productId;
      }
    });

    showStep(1);

    document.querySelector('[data-id="to-step-2"]').addEventListener('click', function() { showStep(2); });
    document.querySelector('[data-id="back-to-step-1"]').addEventListener('click', function() { showStep(1); });
    document.querySelector('[data-id="to-step-3"]').addEventListener('click', function() { showStep(3); });
    document.querySelector('[data-id="back-to-step-2"]').addEventListener('click', function() { showStep(2); });

    document.querySelector('[data-id="flow-checkout"]').addEventListener('click', function() {
      var form = document.createElement('form');
      form.method = 'POST';
      form.action = '/cart/add';
      if (selectedPackaging) { var inp = document.createElement('input'); inp.type='hidden'; inp.name='items[][id]'; inp.value=selectedPackaging; form.appendChild(inp); }
      selectedGifts.forEach(function(id){ var inp = document.createElement('input'); inp.type='hidden'; inp.name='items[][id]'; inp.value=id; form.appendChild(inp); });
      if (selectedCard) { var inp = document.createElement('input'); inp.type='hidden'; inp.name='items[][id]'; inp.value=selectedCard; form.appendChild(inp); }
      document.body.appendChild(form);
      form.submit();
    });
  });
</script>

<style>
  .hidden { display: none; }
  .gift-flow { padding: 2rem; }
  .debug-info p { font-size: 0.85rem; color: #555; }
  .flow-indicators { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
  .indicator { flex: 1; text-align: center; padding: 0.75rem; border-bottom: 2px solid #ddd; }
  .indicator.active { border-color: #333; font-weight: bold; }
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
  .btn { background: #333; color: #fff; padding: 0.5rem 1rem; border: none; cursor: pointer; }
</style>

{% schema %}
{
  "name": "Custom Gift Flow",
  "settings": [
    {"type":"text","id":"packaging_step_label","label":"Packaging Step Label","default":"Packaging"},
    {"type":"product","id":"packaging_product_handle","label":"Packaging Product"},
    {"type":"text","id":"packaging_heading","label":"Packaging Heading","default":"Choose Your Box Color"},
    {"type":"text","id":"packaging_subheading","label":"Packaging Subheading","default":"Welcome to the easiest way to send someone a custom gift, in 3 simple steps."},
    {"type":"text","id":"gifts_step_label","label":"Gifts Step Label","default":"Gifts"},
    {"type":"collection","id":"gifts_collection","label":"Gifts Collection"},
    {"type":"text","id":"gifts_heading","label":"Gifts Heading","default":"Choose Your Gifts"},
    {"type":"text","id":"gifts_subheading","label":"Gifts Subheading","default":"We've hand-selected the best gifts in one place. Select from the items below and fill up your gift box!"},
    {"type":"text","id":"card_step_label","label":"Card Step Label","default":"Card"},
    {"type":"collection","id":"card_collection","label":"Card Collection"},
    {"type":"text","id":"card_heading","label":"Card Heading","default":"Pick A Card"},
    {"type":"text","id":"card_subheading","label":"Card Subheading","default":"Complete your box with a hand-written card."},
    {"type":"text","id":"next_button_label","label":"Next Button Label","default":"Next"},
    {"type":"text","id":"back_button_label","label":"Back Button Label","default":"Back"},
    {"type":"text","id":"checkout_button_label","label":"Checkout Button Label","default":"Go to Checkout"}
  ],
  "presets":[{"name":"Custom Gift Flow","category":"Custom Sections"}]
}
{% endschema %}
