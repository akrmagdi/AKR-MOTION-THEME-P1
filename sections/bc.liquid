{% comment %}
  Custom Gift Flow – Shopify Liquid 2.0 Section
  File: sections/custom-gift-box-flow.liquid
  Adjustments:
    • Swapped in ProgressBar.js for a smooth, styled progress line
    • “Add to Box” buttons are now type="button" and correctly wired
    • Fixed Liquid collection assignment—no inline ternary
{% endcomment %}

<!-- Include necessary libs (preferably in layout) -->
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<link href="https://cdn.jsdelivr.net/npm/daisyui@3/dist/full.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/progressbar.js"></script>

{% assign headings_string = section.settings.packaging_heading | append: '||' | append: section.settings.gifts_heading | append: '||' | append: section.settings.card_heading | append: '||Enjoy Gifting!' %}
{% assign headings_array  = headings_string | split: '||' %}
{% assign subs_string     = section.settings.packaging_subheading | append: '||' | append: section.settings.gifts_subheading | append: '||' | append: section.settings.card_subheading | append: "||You're all set. Proceed to checkout or build another box." %}
{% assign subs_array      = subs_string | split: '||' %}

<script id="headings-json" type="application/json">{{ headings_array | json }}</script>
<script id="subs-json"     type="application/json">{{ subs_array    | json }}</script>

<section class="gift-flow max-w-7xl mx-auto p-8" data-id="gift-flow">
  <!-- Sticky Summary -->
  <div id="summary-bar" class="sticky top-4 bg-white p-4 border rounded-md shadow mb-6 z-10">
    <h4 class="font-semibold mb-2">Your Box (<span id="summary-count">0</span> items)</h4>
    <div id="summary-thumbs" class="flex space-x-2">
      <span class="text-gray-400">No items yet</span>
    </div>
  </div>

  <!-- Smooth Progress Line via ProgressBar.js -->
  <div id="progress-line" class="mb-8 h-2"></div>

  <!-- Stepper Circles + Labels -->
  <div class="flex justify-between items-center mb-8 relative">
    {% assign step_icons  = "box-open,gift,credit-card,smile" | split: ',' %}
    {% assign step_labels = "Pick Your Giftbox,Choose Your Gifts,Pick A Card,Enjoy Gifting" | split: ',' %}
    {% for icon in step_icons %}
      <div class="flex-1 flex flex-col items-center relative">
        <div class="step-circle w-10 h-10 flex items-center justify-center rounded-full border-2 border-gray-300 bg-white text-gray-400 mb-2 transition-all duration-300" data-step="{{ forloop.index }}">
          <i class="fas fa-{{ icon }}"></i>
        </div>
        <div class="text-xs text-center font-semibold text-gray-700">{{ step_labels[forloop.index0] }}</div>
      </div>
    {% endfor %}
    <style>
      .step-circle.active    { border-color: #3b82f6; background: #3b82f6; color: #fff; }
      .step-circle.completed { border-color: #3b82f6; background: #fff; color: #3b82f6; }
    </style>
  </div>

  <!-- Step Header -->
  <div class="text-center mb-6">
    <p class="text-xs uppercase text-gray-500 mb-1">Step <span id="current-step">1</span> of 4</p>
    <h2 id="current-title" class="text-3xl font-bold text-gray-900">{{ section.settings.packaging_heading }}</h2>
    <p id="current-sub" class="text-gray-600 mt-2">{{ section.settings.packaging_subheading }}</p>
  </div>

  <!-- Steps Content -->
  <div id="steps-wrapper">
    {% for idx in (1..4) %}
      <div class="step-content {% unless idx == 1 %}hidden{% endunless %}" data-step="{{ idx }}">
        {% if idx < 4 %}
          {% comment %}Proper Liquid if/elsif for collections{% endcomment %}
          {% if idx == 1 %}
            {% assign col = collections[section.settings.packaging_collection] %}
          {% elsif idx == 2 %}
            {% assign col = collections[section.settings.gifts_collection] %}
          {% else %}
            {% assign col = collections[section.settings.card_collection] %}
          {% endif %}

          {% if col %}
            <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
              {% for p in col.products %}
                <div class="card border rounded-lg p-4 shadow hover:shadow-lg transition"
                     data-id="{{ p.id }}"
                     data-title="{{ p.title }}"
                     data-price="{{ p.price | money_without_currency }}"
                     data-img="{{ p.featured_image | img_url:'200x' }}">
                  {% if p.featured_image %}
                    <img src="{{ p.featured_image | img_url:'400x' }}"
                         alt="{{ p.title }}"
                         class="w-full h-40 object-cover rounded-md mb-3">
                  {% endif %}
                  <h3 class="font-medium truncate mb-1 text-base">{{ p.title }}</h3>
                  <p class="text-blue-600 font-semibold mb-2 text-base">{{ p.price | money }}</p>
                  <button type="button" class="select-item btn btn-primary w-full uppercase">
                    <i class="fas fa-plus mr-1"></i>
                    {% if idx < 3 %}Add to Box{% else %}Select Card{% endif %}
                  </button>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% else %}
          <div class="flex flex-col items-center justify-center h-48">
            <i class="fas fa-smile text-5xl text-blue-500 mb-4"></i>
            <h3 class="text-2xl font-bold mb-2">Enjoy Gifting!</h3>
            <p class="text-gray-600">You're all set. Proceed to checkout or build another box.</p>
          </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <!-- Navigation Buttons -->
  <div class="flex justify-between mt-6">
    <button id="back-btn" class="btn btn-outline btn-secondary btn-sm" type="button" disabled>
      <i class="fas fa-arrow-left mr-1"></i>{{ section.settings.back_button_label }}
    </button>
    <button id="next-btn" class="btn btn-primary btn-sm" type="button">
      {{ section.settings.next_button_label }}<i class="fas fa-arrow-right ml-1"></i>
    </button>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const totals    = 4;
    let current     = 1;
    const headings  = JSON.parse(document.getElementById('headings-json').textContent);
    const subs      = JSON.parse(document.getElementById('subs-json').textContent);
    const contents  = document.querySelectorAll('.step-content');
    const circles   = document.querySelectorAll('.step-circle');
    const btnNext   = document.getElementById('next-btn');
    const btnBack   = document.getElementById('back-btn');
    const curStep   = document.getElementById('current-step');
    const curTitle  = document.getElementById('current-title');
    const curSub    = document.getElementById('current-sub');
    const sumCount  = document.getElementById('summary-count');
    const sumThumbs = document.getElementById('summary-thumbs');
    let selected    = [];

    // Initialize ProgressBar.js
    const bar = new ProgressBar.Line('#progress-line', {
      strokeWidth: 4,
      trailWidth: 4,
      trailColor: '#e5e7eb',
      strokeColor: '#3b82f6',
      easing: 'easeInOut',
      duration: 300,
      svgStyle: { width: '100%', height: '100%' }
    });

    function updateStepper() {
      circles.forEach((c,i) => {
        c.classList.toggle('active',    i+1 === current);
        c.classList.toggle('completed', i+1 < current);
      });
    }

    function update() {
      // Animate progress
      bar.animate((current - 1) / (totals - 1));

      // Header
      curStep.textContent  = current;
      curTitle.textContent = headings[current-1];
      curSub.textContent   = subs[current-1];

      // Content
      contents.forEach((el,i) => el.classList.toggle('hidden', i+1 !== current));

      // Buttons
      btnBack.disabled = current === 1;
      if (current < totals) {
        btnNext.innerHTML = '{{ section.settings.next_button_label }} <i class="fas fa-arrow-right ml-1"></i>';
      } else {
        btnNext.innerHTML = '<i class="fas fa-shopping-cart mr-1"></i>{{ section.settings.checkout_button_label }}';
      }

      // Summary
      sumCount.textContent = selected.length;
      sumThumbs.innerHTML = selected.length
        ? selected.map(x => `<img src="${x.img}" class="w-10 h-10 rounded" title="${x.title}">`).join('')
        : '<span class="text-gray-400">No items yet</span>';

      updateStepper();
    }

    // Add to Box / Select Card
    document.querySelectorAll('.select-item').forEach(btn => {
      btn.addEventListener('click', e => {
        const card = e.currentTarget.closest('[data-id]');
        selected.push({
          id:    card.dataset.id,
          title: card.dataset.title,
          price: card.dataset.price,
          img:   card.dataset.img
        });
        update();
      });
    });

    // Next / Back handlers
    btnNext.addEventListener('click', () => {
      if (current < totals) { current++; update(); }
      else { window.location.href = '/checkout'; }
    });
    btnBack.addEventListener('click', () => {
      if (current > 1) { current--; update(); }
    });

    update();
  });
</script>

{% schema %}
{
  "name":"Custom Gift Flow",
  "settings":[
    { "type":"collection","id":"packaging_collection","label":"Packaging Collection" },
    { "type":"text","id":"packaging_heading","label":"Packaging Heading","default":"Choose Your Box Color" },
    { "type":"text","id":"packaging_subheading","label":"Packaging Subheading","default":"Pick your favorite box style." },
    { "type":"collection","id":"gifts_collection","label":"Gifts Collection" },
    { "type":"text","id":"gifts_heading","label":"Gifts Heading","default":"Choose Your Gifts" },
    { "type":"text","id":"gifts_subheading","label":"Gifts Subheading","default":"Select items to fill your box." },
    { "type":"collection","id":"card_collection","label":"Card Collection" },
    { "type":"text","id":"card_heading","label":"Card Heading","default":"Select a Card" },
    { "type":"text","id":"card_subheading","label":"Card Subheading","default":"Add a personal message." },
    { "type":"text","id":"next_button_label","label":"Next Button Label","default":"Next" },
    { "type":"text","id":"back_button_label","label":"Back Button Label","default":"Back" },
    { "type":"text","id":"checkout_button_label","label":"Checkout Button Label","default":"Proceed to Checkout" }
  ],
  "presets":[{ "name":"Custom Gift Flow","category":"Custom Sections" }]
}
{% endschema %}
